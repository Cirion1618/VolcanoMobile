<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Volcano Hybrid Test Control v2.16 (Mobile‚Äëfirst)</title>
  <style>
    :root{
      --bg:#111213;
      --panel:#1b1c1e;
      --panel-2:#232427;
      --text:#f3f4f6;
      --muted:#a1a1aa;
      --brand:#22c55e; /* limegreen-ish */
      --danger:#ef4444;
      --warning:#f59e0b;
      --border:#2f3033;
      --focus:#60a5fa;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7f7f8; --panel:#ffffff; --panel-2:#f3f4f6; --text:#0f172a; --muted:#475569; --border:#e5e7eb; }
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height:1.4;
    }
    header{
      position:sticky; top:0; z-index:10; background:var(--panel);
      padding:12px 16px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{ font-weight:700; font-size:clamp(16px, 2.8vw, 20px); }
    .version{ color:var(--muted); font-size:12px; }
    .container{ max-width:980px; margin:0 auto; padding:16px; padding-bottom:calc(88px + env(safe-area-inset-bottom)); }

    /* Status grid */
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (min-width:720px){ .grid{ grid-template-columns:repeat(4,1fr);} }
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px;
      display:flex; flex-direction:column; gap:6px; min-height:72px;
    }
    .label{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.06em; }
    .value{ font-size:clamp(18px, 4vw, 24px); font-weight:700; }

    /* Inputs & buttons */
    input[type="number"], button{
      font: inherit; color:inherit; background:var(--panel);
      border:1px solid var(--border); border-radius:12px; padding:14px 16px; min-height:48px;
    }
    input[type="number"]{ width:100%; background:var(--panel-2); }
    input:focus, button:focus{ outline:2px solid var(--focus); outline-offset:2px; }
    .row{ display:flex; gap:8px; }
    .row.wrap{ flex-wrap:wrap; }
    .grow{ flex:1 1 160px; }

    .btn{ background:var(--panel-2); cursor:pointer; }
    .btn:hover{ filter:brightness(1.08); }
    .btn-primary{ background:var(--brand); color:#0a0a0a; border-color:transparent; }
    .btn-danger{ background:var(--danger); color:#fff; border-color:transparent; }
    .btn-ghost{ background:transparent; }

    /* Progress */
    #progressContainer{ width:100%; height:16px; background:var(--panel-2); border-radius:999px; border:1px solid var(--border); overflow:hidden; }
    #progress{ height:100%; width:0%; background:var(--brand); transition:width .25s ease; }
    @media (prefers-reduced-motion: reduce){ #progress{ transition:none; } }

    /* Log (collapsible) */
    details.log{ background:var(--panel); border:1px solid var(--border); border-radius:12px; }
    details.log>summary{ list-style:none; cursor:pointer; padding:12px 14px; display:flex; gap:10px; align-items:center; }
    details.log>summary::-webkit-details-marker{ display:none; }
    #log{ max-height:240px; overflow:auto; background:var(--panel-2); border-top:1px solid var(--border); padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; border-radius:0 0 12px 12px; }

    /* Bottom toolbar for thumb reachability */
    .toolbar{
      position:fixed; left:0; right:0; bottom:0; z-index:20; background:rgba(17,18,19,.85);
      backdrop-filter: blur(8px); border-top:1px solid var(--border);
      padding:8px 12px calc(8px + env(safe-area-inset-bottom));
    }
    .toolbar .row{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; }
    @media (min-width:720px){ .toolbar .row{ grid-template-columns:repeat(5, max-content); justify-content:center; } }

    /* Workflow manager dialog */
    dialog{ border:1px solid var(--border); border-radius:12px; padding:0; background:var(--panel); color:var(--text); width:min(820px,96vw); }
    dialog::backdrop{ background:rgba(0,0,0,.45); }
    .dialog-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); }
    .dialog-body{ padding:12px 16px; background:var(--panel-2); max-height:min(65vh, 520px); overflow:auto; }
    .table{ width:100%; border-collapse:collapse; }
    .table th,.table td{ border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; font-size:13px; }

    /* Toast */
    .toast-container{ position:fixed; left:0; right:0; bottom:calc(76px + env(safe-area-inset-bottom)); display:flex; justify-content:center; z-index:40; pointer-events:none; }
    .toast{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px 14px; font-size:14px; box-shadow:0 10px 30px rgba(0,0,0,.35); opacity:0; transform:translateY(6px); transition:opacity .18s ease, transform .18s ease; }
    .toast.show{ opacity:1; transform:translateY(0); }

    .muted{ color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Volcano Hybrid ‚Äì Advanced Control Panel</div>
      <div class="version">v2.16 ¬∑ Mobile‚Äëfirst</div>
    </div>
    <div class="muted" id="status" aria-live="polite">Status: Not connected</div>
  </header>

  <main class="container">
    <!-- Status cards -->
    <section class="grid" aria-label="Device status">
      <div class="card"><div class="label">Current Temp</div><div class="value"><span id="currentTemp">-</span> ¬∞C</div></div>
      <div class="card"><div class="label">Heater</div><div class="value" id="heaterStatus">Unknown</div></div>
      <div class="card"><div class="label">Pump</div><div class="value" id="pumpStatus">Unknown</div></div>
      <div class="card"><div class="label">Firmware</div><div class="value" id="firmwareVersion">-</div></div>
    </section>

    <!-- Manual controls -->
    <section style="margin-top:16px; display:grid; gap:8px;">
      <!--
      <div class="row wrap">
        <label class="grow" for="manualTemp" style="display:flex; flex-direction:column; gap:6px;">
          <span class="label">Manual Temp (¬∞C)</span>
          <input type="number" id="manualTemp" inputmode="numeric" placeholder="e.g. 185" min="40" max="230" step="1" />
        </label>
        <button class="btn btn-primary" id="btnSetTemp" aria-label="Set temperature" onclick="setManualTemperature()">Set Temp</button>
        <button class="btn" id="pumpToggle" aria-pressed="false" onclick="togglePump()">Start Pump</button>
      </div>
      -->

      <div id="progressContainer" aria-label="Workflow progress"><div id="progress"></div></div>

      <!-- Log now directly under progress bar -->
      <details class="log" open style="margin-top:8px;">
        <summary>
          <span>Event Log</span>
        </summary>
        <div id="log" role="log" aria-live="polite"></div>
      </details>
    </section>

    <!-- Workflows -->
    <section id="workflows" style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <button class="btn" onclick="runWorkflowX()">üöÄ Start Custom Workflow X</button>
      <button class="btn" onclick="addCustomWorkflow()">‚ûï Add Workflow</button>
      <button class="btn" onclick="openWorkflowManager()">üóÇ Manage Workflows</button>
      <button class="btn" onclick="clearLog()">üßπ Clear Log</button>
      <span id="customRunButtons" style="display:contents"></span>
    </section>
  </main>

  <!-- Workflow Manager Dialog -->
  <dialog id="workflowDialog">
    <div class="dialog-header">
      <div><strong>Manage Workflows</strong></div>
      <div class="row">
        <button class="btn" onclick="closeWorkflowManager()">Close</button>
      </div>
    </div>
    <div class="dialog-body">
      <div id="workflowList"></div>
    </div>
  </dialog>

  <!-- Toast root (created dynamically if missing) -->

  <!-- Bottom reachable toolbar -->
  <nav class="toolbar" aria-label="Primary actions">
    <div class="row">
      <button class="btn" onclick="connect()">üîó Connect</button>
      <button class="btn btn-primary" onclick="runWorkflowX()">‚ñ∂Ô∏è Start</button>
      <button class="btn btn-danger" onclick="abortWorkflow()">‚õî Abort</button>
      <button class="btn" id="pumpToggleBottom" onclick="togglePump()">üí® Pump</button>
      <button class="btn" style="display:none;" id="clearBottom" onclick="clearLog()">üßπ</button>
    </div>
  </nav>

  <script>
    // --- Original logic kept, UI improved for mobile ---
    let server, service, device;
    let abortFlag = false;
    let workflowActive = false;
    let polling = false;
    let pumpRunning = false; // ensure declared

    // --- Audio feedback + popup/notification ---
    let audioCtx = null;
    function getAudioCtx(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }
    // Ensure audio is allowed after the first user interaction
    window.addEventListener('pointerdown', () => { try { getAudioCtx().resume(); } catch(_){} }, { once:true });

    function playCompletionSound(){
      try{
        const ctx = getAudioCtx();
        const now = ctx.currentTime;
        const master = ctx.createGain();
        master.gain.value = 0.08; // gentle volume
        master.connect(ctx.destination);
        const freqs = [523.25, 659.25, 783.99]; // C5, E5, G5
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.value = f;
          o.connect(g); g.connect(master);
          const t = now + i*0.06;
          g.gain.setValueAtTime(0, t);
          g.gain.linearRampToValueAtTime(1, t + 0.01);
          g.gain.exponentialRampToValueAtTime(0.001, t + 0.22);
          o.start(t);
          o.stop(t + 0.24);
        });
      }catch(e){ console.warn('Sound playback failed:', e); }
    }

    function ensureToastContainer(){
      let c = document.querySelector('.toast-container');
      if (!c){ c = document.createElement('div'); c.className = 'toast-container'; document.body.appendChild(c); }
      return c;
    }
    function showToast(message){
      const c = ensureToastContainer();
      const el = document.createElement('div');
      el.className = 'toast';
      el.setAttribute('role','status');
      el.textContent = message;
      c.appendChild(el);
      requestAnimationFrame(()=> el.classList.add('show'));
      setTimeout(()=>{
        el.classList.remove('show');
        el.addEventListener('transitionend', ()=> el.remove(), { once:true });
      }, 3200);
    }

    async function notifyCompletion(){
      try{
        if ("Notification" in window){
          if (Notification.permission === 'granted'){
            new Notification('Workflow completed', { body: 'All steps done.', silent:false });
          } else if (Notification.permission !== 'denied'){
            const perm = await Notification.requestPermission();
            if (perm === 'granted') new Notification('Workflow completed', { body: 'All steps done.', silent:false });
          }
        }
      }catch(_){}
      showToast('‚úÖ Workflow completed');
    }

    const serviceUUID = '10110000-5354-4f52-5a26-4249434b454c';
    const pumpOnUUID = '10110013-5354-4f52-5a26-4249434b454c';
    const pumpOffUUID = '10110014-5354-4f52-5a26-4249434b454c';

    // Additional UUIDs & connection hints
    const firmwareServiceUUID = '10100000-5354-4f52-5a26-4249434b454c';
    const namePrefixHint = null; // e.g., 'Volcano' to narrow chooser (optional)

    // Persist & restore previously authorized device
    function persistKnownDevice(dev){
      try{
        localStorage.setItem('volcanoDeviceId', dev.id);
        localStorage.setItem('volcanoDeviceName', dev.name || '');
        localStorage.setItem('volcanoDeviceLastSeen', String(Date.now()));
      }catch(e){}
    }
    async function tryGetKnownDevice(){
      try{
        if (!navigator.bluetooth.getDevices) return null;
        const id = localStorage.getItem('volcanoDeviceId');
        const name = localStorage.getItem('volcanoDeviceName');
        const devices = await navigator.bluetooth.getDevices();
        let found = null;
        if (id) found = devices.find(d => d.id === id);
        if (!found && name) found = devices.find(d => (d.name||'') === name);
        return found || null;
      }catch(e){ return null; }
    }

    const customWorkflows = {};

    function saveWorkflows() {
      try { localStorage.setItem('customWorkflows', JSON.stringify(customWorkflows)); } catch (e) { console.error('Failed to save workflows', e); }
    }
    function loadWorkflows() {
      try {
        const data = localStorage.getItem('customWorkflows');
        if (data) {
          const stored = JSON.parse(data);
          Object.assign(customWorkflows, stored);
        }
        renderWorkflowButtons();
      } catch (e) { console.error('Failed to load workflows', e); }
    }

    function renderWorkflowButtons(){
      const container = document.getElementById('customRunButtons');
      if (!container) return;
      container.innerHTML = '';
      Object.keys(customWorkflows).forEach(name => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.dataset.runWorkflow = name;
        btn.textContent = 'üöÄ Run ' + name;
        btn.onclick = () => runWorkflow(customWorkflows[name]);
        container.appendChild(btn);
      });
    }

    const workflowX_temperature = [175, 180, 185, 190, 195];
    const workflowX_holdTimeInMilliSeconds = [10000, 7000, 7000, 7000, 7000];
    const workflowX_pumpTimeInMilliSeconds = [5000, 6000, 7000, 8000, 8000];

    function log(msg) {
      const now = new Date();
      const time = now.toLocaleTimeString('de-DE', { hour12: false });
      const el = document.getElementById('log');
      const line = document.createElement('div');
      line.textContent = `[${time}] ${msg}`;
      el.insertBefore(line, el.firstChild);
      // Newest on top
      requestAnimationFrame(() => { el.scrollTop = 0; });
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function updateProgress(percent){
      const bar = document.getElementById('progress');
      if (bar) bar.style.width = Math.max(0, Math.min(100, percent)) + '%';
    }

    let progressTotalSteps = 0; let progressCurrentStep = 0;
    function startProgressSteps(totalSteps){ progressTotalSteps = totalSteps; progressCurrentStep = 0; updateProgress(0); }
    function advanceProgressStep(){ progressCurrentStep++; if (progressTotalSteps>0){ updateProgress(Math.min((progressCurrentStep/progressTotalSteps)*100,100)); } }
    function stopProgress(){ progressTotalSteps = 0; progressCurrentStep = 0; updateProgress(0); }

    async function getCurrentTemp(){
      const char = await service.getCharacteristic('10110001-5354-4f52-5a26-4249434b454c');
      const value = await char.readValue();
      return new DataView(value.buffer).getUint16(0, true);
    }

    async function estimateTotalTime(temps, holds, pumps){
      let total = 0; let current = await getCurrentTemp();
      for (let i=0; i<temps.length; i++){
        const target = temps[i]*10; const heatTime = Math.max(target-current,0)*5; // heuristic
        total += heatTime + holds[i] + pumps[i]; current = target;
      }
      return total;
    }

    function clearLog(){ document.getElementById('log').innerText=''; }

    async function setManualTemperature(){
      const val = parseInt(document.getElementById('manualTemp').value, 10);
      if (isNaN(val)){ log('‚ö†Ô∏è Enter a valid temperature'); return; }
      await setTemperature(val*10);
      await startHeater();
    }

    function syncPumpButtons(){
      const top = document.getElementById('pumpToggle');
      const bottom = document.getElementById('pumpToggleBottom');
      const label = pumpRunning ? 'Stop Pump' : 'Start Pump';
      if (top){ top.innerText = label; top.setAttribute('aria-pressed', String(pumpRunning)); }
      if (bottom){ bottom.innerText = pumpRunning ? 'üõë Pump' : 'üí® Pump'; bottom.setAttribute('aria-pressed', String(pumpRunning)); }
      document.getElementById('pumpStatus').innerText = pumpRunning ? 'ON' : 'OFF';
    }

    async function togglePump(){ if (!pumpRunning){ await startPumpOnly(); } else { await stopPump(); } }

    async function wait(ms){ const interval=100; const steps=Math.floor(ms/interval); for (let i=0;i<steps;i++){ if (abortFlag) throw new Error('Aborted'); await sleep(interval); } }

    async function connect(){
      try{
        // 1) Try previously authorized device (no chooser)
        let known = null;
        try{ if (navigator.bluetooth.getDevices) known = await tryGetKnownDevice(); }catch(_){}
        if (!device && known){
          device = known;
          log('üîÅ Using previously authorized device: ' + (device.name || device.id));
        }

        // 2) If none, open chooser with filters (narrow the list)
        if (!device){
          const filters = [{ services: [serviceUUID] }];
          if (namePrefixHint){ filters.push({ namePrefix: namePrefixHint, services: [serviceUUID] }); }
          device = await navigator.bluetooth.requestDevice({
            filters,
            optionalServices: [firmwareServiceUUID, serviceUUID]
          });
          log('üì∂ Selected device: ' + (device.name || device.id));
        }

        document.getElementById('status').innerText = `Status: Connecting to ${device.name || 'device'}...`;
        server = await device.gatt.connect();
        service = await server.getPrimaryService(serviceUUID);
        document.getElementById('status').innerText = `Status: Connected to ${device.name || device.id}`;
        log('Connected to device: ' + (device.name || device.id));

        // Remember device for next time
        persistKnownDevice(device);
        device.addEventListener('gattserverdisconnected', () => {
          document.getElementById('status').innerText = 'Status: Disconnected';
          log('üîå Disconnected');
        });

        await readFirmwareVersion();
        polling = true; pollStatuses();
        if (navigator.vibrate) navigator.vibrate(20);
      }catch(err){ document.getElementById('status').innerText = `Connection failed: ${err.message}`; log('Connection error: ' + err); }
    }

    async function readFirmwareVersion(){
      try{
        const fwService = await server.getPrimaryService(firmwareServiceUUID);
        const fwChar = await fwService.getCharacteristic('10100003-5354-4f52-5a26-4249434b454c');
        const value = await fwChar.readValue();
        const decoder = new TextDecoder('utf-8');
        const fw = decoder.decode(value);
        document.getElementById('firmwareVersion').innerText = fw.substring(0,8);
        log('üÜï Firmware Version: ' + fw);
      }catch(e){ log('‚ö†Ô∏è Error reading firmware version: ' + e); }
    }

    async function runWorkflow(config){
      const temps=config.temperature; const holds=config.holdTimeInMilliSeconds; const pumps=config.pumpTimeInMilliSeconds;
      workflowActive = true; abortFlag = false; log(`========= START ${config.name||'WORKFLOW'} =========`);
      try{
        startProgressSteps(temps.length);
        await stopPump(); await sleep(300); await stopHeater(); await sleep(300);
        for (let i=0;i<temps.length;i++){
          if (abortFlag) throw new Error('Aborted');
          const targetTemp=temps[i]*10; const holdTime=holds[i]; const pumpTime=pumps[i];
          log(`üß≠ STEP ${i+1}: Target ${targetTemp/10}¬∞C, Hold ${holdTime}ms, Pump ${pumpTime}ms`);
          await stopPump(); await sleep(300);
          await setTemperature(targetTemp); await wait(2000); if (abortFlag) throw new Error('Aborted');
          await startHeater(); await wait(500);
          await waitForTemp(targetTemp); if (abortFlag) throw new Error('Aborted');
          log(`‚è≥ Holding for ${holdTime}ms`); await preciseWait(holdTime); if (abortFlag) throw new Error('Aborted');
          if (pumpTime>0){ await startPumpOnly(); log(`üí® Pumping for ${pumpTime}ms`); await preciseWait(pumpTime); await stopPump(); log('üõë Pump OFF'); }
          else { log('‚è≠Ô∏è Skipping pump phase'); }
          await wait(500); advanceProgressStep();
        }
        await stopPump(); await stopHeater(); stopProgress(); updateProgress(100); log('‚úÖ Workflow completed.');
        playCompletionSound();
        notifyCompletion();
        if (navigator.vibrate) navigator.vibrate([20,60,20]);
      }catch(e){
        if (e.message==='Aborted'){ log('‚ùå Workflow aborted.'); await stopPump(); await stopHeater(); stopProgress(); updateProgress(0); }
        else { log('‚ö†Ô∏è Error during workflow: ' + e); }
      }finally{ workflowActive=false; stopProgress(); }
    }

    function runWorkflowX(){
      runWorkflow({ name:'Workflow X', temperature:workflowX_temperature, holdTimeInMilliSeconds:workflowX_holdTimeInMilliSeconds, pumpTimeInMilliSeconds:workflowX_pumpTimeInMilliSeconds });
    }

    function promptSteps(){
      while(true){
        const s = prompt('How many steps (2‚Äì8)?');
        if (s === null) return null;
        const n = parseInt(String(s).trim(), 10);
        if (!Number.isNaN(n) && n>=2 && n<=8) return n;
        alert('Please enter a number between 2 and 8.');
      }
    }

    function promptNumber(label, validator){
      while(true){
        const s = prompt(label);
        if (s === null) return null;
        const n = parseFloat(String(s).replace(',', '.').trim());
        if (Number.isNaN(n)) { alert('Please enter a valid number.'); continue; }
        if (validator && !validator(n)) { alert('Value out of allowed range.'); continue; }
        return n;
      }
    }

    function addCustomWorkflow(){
      const name = prompt('Workflow name:');
      if (!name) return;

      const steps = promptSteps();
      if (steps === null) return;

      const temps = [];
      const holds = [];
      const pumps = [];

      for (let i = 0; i < steps; i++){
        const t = promptNumber(`Step ${i+1} ‚Äî Temperature (¬∞C 40‚Äì230):`, v => v>=40 && v<=230);
        if (t === null) return;
        const hSec = promptNumber(`Step ${i+1} ‚Äî Hold time (seconds, ‚â•0):`, v => v>=0);
        if (hSec === null) return;
        const pSec = promptNumber(`Step ${i+1} ‚Äî Pump time (seconds, 0‚Äì35):`, v => v>=0 && v<=35);
        if (pSec === null) return;
        temps.push(Math.round(t));
        holds.push(Math.round(hSec*1000));
        pumps.push(Math.round(pSec*1000));
      }

      if (customWorkflows[name] && !confirm('Workflow exists. Overwrite?')) return;
      customWorkflows[name] = { name, temperature:temps, holdTimeInMilliSeconds:holds, pumpTimeInMilliSeconds:pumps };
      saveWorkflows();
      renderWorkflowButtons();
      log('Added/Updated workflow ' + name);
    }

    function abortWorkflow(){ log('‚ùå Abort requested.'); abortFlag = true; }

    async function setTemperature(tempInTenthDegrees){
      const char = await service.getCharacteristic('10110003-5354-4f52-5a26-4249434b454c');
      const buffer = new ArrayBuffer(2); new DataView(buffer).setUint16(0, tempInTenthDegrees, true);
      await char.writeValue(buffer); log(`üå°Ô∏è Set temperature to ${tempInTenthDegrees/10}¬∞C`);
    }

    async function startHeater(){
      const char = await service.getCharacteristic('1011000f-5354-4f52-5a26-4249434b454c');
      await char.writeValue(new Uint8Array([0x01])); log('üî• Heater ON');
    }
    async function stopHeater(){
      const char = await service.getCharacteristic('10110010-5354-4f52-5a26-4249434b454c');
      await char.writeValue(new Uint8Array([0x01])); log('üõë Heater OFF');
    }

    async function waitForTemp(targetTemp){
      const char = await service.getCharacteristic('10110001-5354-4f52-5a26-4249434b454c');
      let temp = 0;
      while (Math.abs(temp - targetTemp) > 10){
        if (abortFlag) throw new Error('Aborted');
        const value = await char.readValue();
        temp = new DataView(value.buffer).getUint16(0, true);
        document.getElementById('currentTemp').innerText = (temp/10).toFixed(1);
        log(`Current temp: ${temp/10}¬∞C`);
        await wait(1500);
      }
      log('‚úÖ Target temperature reached');
    }

    let pumpSafetyTimer = null;
    async function startPumpOnly(){
      const char = await service.getCharacteristic(pumpOnUUID);
      await char.writeValue(new Uint8Array([0x01]));
      pumpRunning = true; syncPumpButtons(); log('üí® Pump ON');
      pumpSafetyTimer = setTimeout(()=>{ stopPump(); log('‚õëÔ∏è Failsafe: Pump auto-stopped after timeout'); }, 20000);
    }
    async function stopPump(){
      if (pumpSafetyTimer){ clearTimeout(pumpSafetyTimer); pumpSafetyTimer=null; }
      const char = await service.getCharacteristic(pumpOffUUID);
      await char.writeValue(new Uint8Array([0x00]));
      pumpRunning = false; syncPumpButtons(); log('üõë Pump OFF');
    }

    async function updateStatuses(){
      try{
        const tempChar = await service.getCharacteristic('10110001-5354-4f52-5a26-4249434b454c');
        const tempVal = await tempChar.readValue();
        const temp = new DataView(tempVal.buffer).getUint16(0, true);
        document.getElementById('currentTemp').innerText = (temp/10).toFixed(1);
        const prj2Char = await server.getPrimaryService('10100000-5354-4f52-5a26-4249434b454c').then(svc=>svc.getCharacteristic('1010000d-5354-4f52-5a26-4249434b454c'));
        const prj2Val = await prj2Char.readValue();
        const prj2 = new DataView(prj2Val.buffer).getUint16(0, true);
        const heaterOn = (prj2 & 0x0004) === 0; // per your original logic
        document.getElementById('heaterStatus').innerText = heaterOn ? 'ON' : 'OFF';
      }catch(err){ log('‚ö†Ô∏è Error updating statuses: ' + err); }
    }

    async function pollStatuses(){ while (polling){ if (!workflowActive){ await updateStatuses(); } await sleep(3000); } }

    async function preciseWait(ms){ const start=performance.now(); while (performance.now()-start<ms){ if (abortFlag) throw new Error('Aborted'); await sleep(50); } }

    // ---- Workflow Manager (view/edit/delete/run) ----
    function openWorkflowManager(){ renderWorkflowManager(); const dlg=document.getElementById('workflowDialog'); if (dlg && !dlg.open) dlg.showModal(); }
    function closeWorkflowManager(){ const dlg=document.getElementById('workflowDialog'); if (dlg && dlg.open) dlg.close(); }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/\"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function fmtSeconds(ms){ const s = ms/1000; return Number.isInteger(s) ? String(s) : s.toFixed(1); }

    function renderWorkflowManager(){
      const wrap = document.getElementById('workflowList'); if (!wrap) return;
      const names = Object.keys(customWorkflows);
      if (!names.length){ wrap.innerHTML = '<p class="muted">No custom workflows yet. Create one with ‚ÄúAdd Workflow‚Äù.</p>'; return; }
      let html = '';
      names.forEach(name => {
        const wf = customWorkflows[name];
        html += `<details open><summary><strong>${escapeHtml(name)}</strong> ‚Äî ${wf.temperature.length} steps</summary>`;
        html += '<div style="margin-top:8px;"><table class="table"><thead><tr><th>#</th><th>Temp (¬∞C)</th><th>Hold (s)</th><th>Pump (s)</th><th>Actions</th></tr></thead><tbody>';
        for (let i=0;i<wf.temperature.length;i++){
          html += `<tr><td>${i+1}</td><td>${wf.temperature[i]}</td><td>${fmtSeconds(wf.holdTimeInMilliSeconds[i])}</td><td>${fmtSeconds(wf.pumpTimeInMilliSeconds[i])}</td>` +
                  `<td><button class=\"btn\" onclick=\"runNamedWorkflow('${encodeURIComponent(name)}')\">Run</button> ` +
                  `<button class=\"btn\" onclick=\"openEditWorkflow('${encodeURIComponent(name)}')\">Edit</button> ` +
                  `<button class=\"btn btn-danger\" onclick=\"deleteWorkflow('${encodeURIComponent(name)}')\">Delete</button></td></tr>`;
        }
        html += '</tbody></table></div></details>';
      });
      wrap.innerHTML = html;
    }

    function runNamedWorkflow(encodedName){ const name = decodeURIComponent(encodedName); if (customWorkflows[name]) runWorkflow(customWorkflows[name]); }
    function deleteWorkflow(encodedName){ const name = decodeURIComponent(encodedName); if (!customWorkflows[name]) return; if (confirm(`Delete workflow "${name}"?`)){ delete customWorkflows[name]; saveWorkflows(); renderWorkflowButtons(); renderWorkflowManager(); log('üóë Deleted workflow ' + name); } }

    function openEditWorkflow(encodedName){
      const name = decodeURIComponent(encodedName);
      const wf = customWorkflows[name]; if (!wf) return;
      const dlg=document.getElementById('workflowDialog'); if (dlg && !dlg.open) dlg.showModal();
      const wrap = document.getElementById('workflowList');
      wrap.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
          <strong>Edit Workflow: ${escapeHtml(name)}</strong>
          <div class="row">
            <button class="btn" onclick="renderWorkflowManager()">Back</button>
          </div>
        </div>
        <div>
          <table class="table">
            <thead><tr><th>#</th><th>Temp (¬∞C)</th><th>Hold (s)</th><th>Pump (s)</th></tr></thead>
            <tbody id="editBody"></tbody>
          </table>
          <div class="row" style="margin-top:8px; gap:8px;">
            <button class="btn" onclick="addEditRow()">‚ûï Add Step</button>
            <button class="btn btn-danger" onclick="removeEditRow()">‚ûñ Remove Last</button>
          </div>
          <div class="row" style="margin-top:12px; gap:8px;">
            <button class="btn btn-primary" onclick="saveEditWorkflow('${encodeURIComponent(name)}')">üíæ Save</button>
            <button class="btn" onclick="renderWorkflowManager()">Cancel</button>
          </div>
          <p class="muted" style="margin-top:8px;">Between 2 and 8 steps. Pump ‚â§ 35 s.</p>
        </div>`;
      // populate rows
      const body = document.getElementById('editBody');
      const steps = wf.temperature.length;
      for (let i=0;i<steps;i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td>
          <td><input type="number" min="40" max="230" step="1" value="${wf.temperature[i]}" /></td>
          <td><input type="number" min="0" step="0.1" value="${(wf.holdTimeInMilliSeconds[i]/1000).toFixed(1).replace(/\.0$/, '')}" /></td>
          <td><input type="number" min="0" max="35" step="0.1" value="${(wf.pumpTimeInMilliSeconds[i]/1000).toFixed(1).replace(/\.0$/, '')}" /></td>`;
        body.appendChild(tr);
      }
    }

    function addEditRow(){
      const body = document.getElementById('editBody'); if (!body) return;
      const rows = body.querySelectorAll('tr');
      if (rows.length >= 8){ alert('Maximum 8 steps'); return; }
      const last = rows[rows.length-1];
      const clone = last.cloneNode(true);
      clone.querySelectorAll('input').forEach((inp, idx) => {
        // Keep same values as last row for convenience
        inp.value = inp.value;
      });
      body.appendChild(clone);
      renumberEditRows();
    }
    function removeEditRow(){
      const body = document.getElementById('editBody'); if (!body) return;
      const rows = body.querySelectorAll('tr');
      if (rows.length <= 2){ alert('Minimum 2 steps'); return; }
      body.removeChild(rows[rows.length-1]);
      renumberEditRows();
    }
    function renumberEditRows(){
      const body = document.getElementById('editBody'); if (!body) return;
      const rows = body.querySelectorAll('tr');
      rows.forEach((tr, i)=>{ tr.firstElementChild.textContent = String(i+1); });
    }

    function saveEditWorkflow(encodedName){
      const name = decodeURIComponent(encodedName);
      const wf = customWorkflows[name]; if (!wf) return;
      const body = document.getElementById('editBody');
      const rows = Array.from(body.querySelectorAll('tr'));
      if (rows.length < 2 || rows.length > 8){ alert('Steps must be between 2 and 8.'); return; }
      const temps=[]; const holds=[]; const pumps=[];
      for (const tr of rows){
        const [tempInp, holdInp, pumpInp] = Array.from(tr.querySelectorAll('input'));
        const t = parseInt(tempInp.value, 10);
        const h = parseFloat(String(holdInp.value).replace(',', '.'));
        const p = parseFloat(String(pumpInp.value).replace(',', '.'));
        if (Number.isNaN(t) || t<40 || t>230){ alert('Temps must be 40‚Äì230 ¬∞C'); return; }
        if (Number.isNaN(h) || h<0){ alert('Hold must be ‚â• 0 s'); return; }
        if (Number.isNaN(p) || p<0 || p>35){ alert('Pump must be 0‚Äì35 s'); return; }
        temps.push(t);
        holds.push(Math.round(h*1000));
        pumps.push(Math.round(p*1000));
      }
      customWorkflows[name] = { name, temperature:temps, holdTimeInMilliSeconds:holds, pumpTimeInMilliSeconds:pumps };
      saveWorkflows();
      renderWorkflowButtons();
      renderWorkflowManager();
      showToast('‚úÖ Saved changes for ' + name);
    }

    // Initialize
    loadWorkflows();
  </script>
</body>
</html>
